# 浏览器内核之---V8 引擎[[22_浏览器渲染原理]]
浏览器内核由渲染引擎 (html+css) 和 js 引擎 (解析 js 代码) 两部分组成
V8 引擎是 js 引擎中的优秀代表

## V8 执行原理
[V8 JavaScript engine](https://v8.dev/)
V8 是用 C ++编写的 Google 开源高性能 JavaScript 和 WebAssembly 引擎 
V8 可以独立运行，也可以嵌入到任何 C ++应用程序中
![[Pasted image 20220608025221.png]]
## 架构
- parse 解析
	- 会将 JavaScript 代码转换成 AST（抽象语法树）
	- 如果函数没有被调用，不会被转换成 AST 
- Ignition 点火装置/解释器
	- 解释器, 将 AST 转换成 ByteCode（字节码）
	- 收集 TurboFan 优化所需要的信息（比如函数参数的类型信息，有了类型才能进行真实的运算）
	- 如果函数只调用一次，Ignition 会解释执行 ByteCode；
- TurboFan 涡轮扇 (增速)
	- 编译器，可以将字节码编译为 CPU 可以直接执行的机器码；
	- 如果一个函数被多次调用，那么就会被标记为热点函数，那么就会经过 TurboFan 转换成优化的机器码，提高代码的执行性能；
	- 若之前优化的机器码并不能正确的处理运算，就会逆向的转换成字节码；(如 sum 函数原来执行的是 number 类型，后来执行变成了 string 类型 ), 此时机器码就会被还原为字节码 
## 词法/语法分析
- 词法分析（ lexical analysis/scanner）
	将字符序列转换成 token 序列的过程。
- 记号化 (token/tokenization)
- 语法分析（syntactic analysis/ parsing/parser）
![[Pasted image 20220608024336.png]]

## 总结
blink 加载文档流后, scanner 将每一个句子拆分为一个个单独的字词, 并将其 token 化, 形成一个个被标记的词,  parse 根据被标记的词的意思并将其拼接进行语法分析, 形成 AST, 然后转为字节码 


# js 执行过程  [[07.对象1]]
### GO (Global Object) 初始化全局对象
js 引擎在执行代码之前，会在堆内存中创建一个全局对象：Global Object（GO）
- GO
	-  该对象所有的作用域（scope）都可以访问； 
	-  里面会包含 Date、Array、String、Number、setTimeout、setInterval 等等； 
	-  其中还有一个 window 属性指向自己；

### ECS 执行上下文栈
js 引擎内部有一个执行上下文栈（Execution Context Stack，简称 ECS），用于执行代码的调用栈。
全局的代码块为了执行会构建一个 Global Execution Context（GEC）；GEC 会被放入到 ECS 中执行；
GEC 放入 ECS
1. 在代码执行前
	在 parser 转成 AST 的过程中，会将全局定义的变量、函数等加入到 GlobalObject 中，但是并不会赋值；
	也称之为变量的作用域提升（hoisting）
2. 在代码执行中，对变量赋值，或者执行其他的函数

### VO（Variable Object）
每一个执行上下文会关联一个 VO（Variable Object，变量对象），变量和函数声明会被添加到这个 VO 对象中。
当全局代码被执行的时候，VO 就是 GO 对象了

## 函数执行  
在执行的过程中执行到一个函数时，就会根据函数体创建一个函数执行上下文（Functional Execution Context，简称 FEC），并且压入到 EC Stack 中。

每个执行上下文都会关联一个 VO, 而函数关联的 VO 叫 AO (Activation Object)
AO 包含 
1. 使用 arguments (实参) 作为初始化，并且初始值是传入的参数；
2. 形参, 形参的值在函数执行前为 undefined, 执行后为传入的实参值
3. 函数内的各种变量

## Scope Chain (作用域链) [[draw07_作用域(函数嵌套).excalidraw]]
当进入到一个执行上下文时，执行上下文会关联一个作用域链（Scope Chain）
作用域链是一个对象列表，用于变量标识符的求值；
当进入一个执行上下文时，这个作用域链被创建，并且根据代码类型，添加一系列的对象；

作用域与函数的定义位置有关, 与调用位置无关
调用与函数定义的位置无关, 与调用位置有关


----
# 面试题:
## 作用域提升
